 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>sXam OS | Modern Architect</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #4285F4; 
            --bg: #000000; 
            --card: #0d0d0d; 
            --text: #f1f3f4;
            --border: rgba(255, 255, 255, 0.08);
            --glass: rgba(255, 255, 255, 0.03);
            --red: #EA4335;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
        }

        /* --- MODERN COMPONENTS --- */
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid var(--border); border-radius: 32px; }
        .bento-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; }
        .wide { grid-column: span 2; }

        .tab-content { display: none; height: calc(100vh - 160px); overflow-y: auto; padding-bottom: 100px; }
        .tab-content.active { display: block; animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HEADER & CLOCK --- */
        .header-section { text-align: center; padding: 45px 20px 20px; position: relative; }
        #timer-label { font-size: 10px; font-weight: 900; letter-spacing: 3px; color: #555; text-transform: uppercase; }
        #countdown-timer { font-family: 'Lexend'; font-size: 55px; font-weight: 900; letter-spacing: -3px; margin: 8px 0; }
        .pulse { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { opacity: 1; } 50% { opacity: 0.6; color: var(--accent); } 100% { opacity: 1; } }

        .xp-badge { background: var(--accent); color: #000; padding: 4px 14px; border-radius: 50px; font-size: 10px; font-weight: 900; }

        /* --- PROTOCOLS --- */
        .task-card { display: flex; align-items: center; padding: 18px; background: rgba(255,255,255,0.02); border-radius: 24px; margin-bottom: 10px; border: 1px solid var(--border); transition: 0.3s; }
        .task-card.done { opacity: 0.3; filter: grayscale(1); }
        .task-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .task-checkbox.checked { background: var(--accent); }

        /* --- BATTLEFIELD CALENDAR --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
        .day-box { aspect-ratio: 1; background: var(--glass); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: #333; border: 1px solid transparent; cursor: pointer; }
        .day-box.active { color: #fff; border-color: #444; }
        .day-box.win { background: #34A853 !important; color: #000 !important; box-shadow: 0 0 15px rgba(52, 168, 83, 0.4); }
        .day-box.has-note { border-color: var(--accent); }

        /* --- NAVIGATION --- */
        .dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(15,15,15,0.8); backdrop-filter: blur(20px); padding: 12px 35px; border-radius: 50px; display: flex; gap: 40px; border: 1px solid var(--border); z-index: 1000; }
        .nav-btn { font-size: 20px; color: #333; transition: 0.3s; cursor: pointer; }
        .nav-btn.active { color: var(--accent); text-shadow: 0 0 15px var(--accent); }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; padding: 25px; }
        .modal-content { background: #0a0a0a; border: 1px solid var(--border); border-radius: 35px; padding: 30px; width: 100%; max-width: 450px; position: relative; }
        textarea, .st-input { width: 100%; background: #000; border: 1px solid var(--border); border-radius: 15px; color: #fff; padding: 15px; font-family: 'Inter'; margin-top: 15px; }
        textarea { height: 150px; resize: none; border-left: 4px solid var(--accent); }

        #sleep-screen { position: fixed; inset: 0; background: #000; z-index: 50000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body onload="bootOS()">

    <!-- Sleep Lock -->
    <div id="sleep-screen">
        <div style="font-size: 40px; margin-bottom: 20px;">ðŸŒ™</div>
        <h1 style="font-family:'Lexend'; color: var(--accent);">SYSTEM RECOVERY</h1>
        <p style="color: #444;">Protocol resumes at 07:00 AM</p>
    </div>

    <!-- Header -->
    <div class="header-section">
        <div id="timer-label">MISSION STATUS</div>
        <div id="countdown-timer" class="pulse">00:00:00</div>
        <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
            <div class="xp-badge" id="rank-tag">APPRENTICE</div>
            <div style="font-size: 10px; font-weight: 900; color: #555;" id="xp-tag">XP 0</div>
        </div>
    </div>

    <main>
        <!-- Home Dashboard -->
        <div id="tab-home" class="tab-content active">
            <div class="bento-grid">
                <div class="glass-panel wide" style="padding: 25px;">
                    <div style="font-size: 11px; font-weight: 900; color: var(--accent); margin-bottom: 20px; letter-spacing: 1px;">ACTIVE PROTOCOLS</div>
                    <div id="protocol-list"></div>
                    <button onclick="openSettings()" style="width: 100%; background: none; border: 1px dashed #333; color: #444; padding: 16px; border-radius: 20px; font-weight: 800; font-size: 11px; margin-top: 15px;">+ MANAGE PROTOCOLS</button>
                </div>

                <div class="glass-panel" style="text-align: center; padding: 22px;">
                    <div style="font-size: 32px; font-weight: 900; font-family: 'Lexend';" id="stat-streak">0</div>
                    <div style="font-size: 9px; font-weight: 900; color: #444; margin-top: 5px; letter-spacing: 1px;">STREAK</div>
                </div>

                <div class="glass-panel" style="text-align: center; padding: 22px;">
                    <div style="font-size: 32px; font-weight: 900; font-family: 'Lexend';" id="stat-lvl">1</div>
                    <div style="font-size: 9px; font-weight: 900; color: #444; margin-top: 5px; letter-spacing: 1px;">LEVEL</div>
                </div>
            </div>
        </div>

        <!-- Battlefield -->
        <div id="tab-battle" class="tab-content">
            <div style="padding: 25px;">
                <div style="font-family: 'Lexend'; font-size: 20px; font-weight: 900;">BATTLEFIELD</div>
                <div style="font-size: 10px; font-weight: 800; color: #444; margin-top: 5px;">CHRONICLE YOUR VICTORIES</div>
                <div class="cal-grid" id="cal-grid"></div>
            </div>
        </div>
    </main>

    <!-- Journal Modal -->
    <div class="modal-overlay" id="journal-modal">
        <div class="modal-content">
            <div id="modal-date" style="font-family:'Lexend'; font-weight:900; color: var(--accent); font-size: 18px;">Date</div>
            <textarea id="journal-input" placeholder="Architect, record your progress..."></textarea>
            <button onclick="saveNote()" style="width:100%; background: var(--accent); border:none; padding:18px; border-radius:20px; font-weight:900; margin-top:20px; color: #000;">LOG TO ARCHIVE</button>
            <button onclick="closeModal()" style="width:100%; background: none; border:none; color: #444; margin-top: 10px; font-weight: 700;">DISMISS</button>
        </div>
    </div>

    <!-- Settings Modal (Protocol Manager) -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content" style="max-height: 85vh; overflow-y: auto;">
            <h3 style="font-family:'Lexend'; margin-bottom: 20px;">PROTOCOL MANAGER</h3>
            <div id="settings-task-list"></div>
            <hr style="border: 0; border-top: 1px solid #222; margin: 25px 0;">
            <div style="font-size: 11px; font-weight: 900; color: var(--accent); margin-bottom: 10px;">ADD NEW PROTOCOL</div>
            <input type="text" id="new-task-name" class="st-input" placeholder="Protocol Name" style="margin-top:0;">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="new-task-start" class="st-input" placeholder="Start (e.g. 0700)">
                <input type="number" id="new-task-end" class="st-input" placeholder="End (e.g. 0900)">
            </div>
            <button onclick="addNewTask()" style="width:100%; background: #fff; color:#000; border:none; padding:18px; border-radius:20px; font-weight:900; margin-top:20px;">ADD TO SYSTEM</button>
            <button onclick="closeModal()" style="width:100%; background: none; border:none; color: #444; margin-top: 10px; font-weight: 700;">EXIT SETTINGS</button>
        </div>
    </div>

    <!-- Navigation Dock -->
    <nav class="dock">
        <div class="nav-btn active" onclick="switchTab('home', this)"><i class="fas fa-ghost"></i></div>
        <div class="nav-btn" onclick="switchTab('battle', this)"><i class="fas fa-calendar-alt"></i></div>
        <div class="nav-btn" onclick="openSettings()"><i class="fas fa-sliders-h"></i></div>
    </nav>

    <script>
        const OS = {
            xp: parseInt(localStorage.getItem('os_xp')) || 0,
            protocols: [
                { id: 'p1', t: 'Warm Water Intake', s: 700, e: 900 },
                { id: 'p2', t: 'Morning Skincare', s: 710, e: 910 },
                { id: 'p3', t: 'Focus Work Session', s: 1000, e: 1400 },
                { id: 'p4', t: 'Hydration Cycle', s: 0, e: 2359 },
                { id: 'p5', t: 'Night Wash & Serum', s: 2030, e: 2230 },
                { id: 'p6', t: 'Sleep Protocol', s: 2200, e: 2230 }
            ],
            history: JSON.parse(localStorage.getItem('os_history') || "{}"),
            notes: JSON.parse(localStorage.getItem('os_notes') || "{}"),
            selectedDate: null
        };

        function bootOS() {
            // Load saved protocols
            const savedP = localStorage.getItem('os_protocols');
            if(savedP) OS.protocols = JSON.parse(savedP);

            // Legacy XP migration
            const legacyXP = localStorage.getItem('v21_xp');
            if(legacyXP && !localStorage.getItem('os_xp')) OS.xp = parseInt(legacyXP);

            renderProtocols();
            renderXP();
            updateClock();
            setInterval(updateClock, 1000);
            checkDailyReset();
        }

        // --- COUNTDOWN LOGIC ---
        function updateClock() {
            const now = new Date();
            const time = now.getHours() * 100 + now.getMinutes();
            
            document.getElementById('sleep-screen').style.display = (time >= 2230 || time < 700) ? 'flex' : 'none';

            let next = OS.protocols.find(p => p.s > time);
            let active = OS.protocols.find(p => time >= p.s && time < p.e && p.id !== 'p4');

            const clock = document.getElementById('countdown-timer');
            const label = document.getElementById('timer-label');

            let target;
            if(active) {
                label.innerText = "PROTOCOL ACTIVE ENDS IN";
                target = active.e;
            } else if(next) {
                label.innerText = "NEXT PROTOCOL STARTS IN";
                target = next.s;
            } else {
                label.innerText = "SYSTEM REBOOT IN";
                target = 700;
            }
            clock.innerText = getTimer(target);
        }

        function getTimer(target) {
            const now = new Date();
            let tDate = new Date();
            tDate.setHours(Math.floor(target/100), target%100, 0);
            if(tDate < now) tDate.setDate(tDate.getDate() + 1);
            let diff = tDate - now;
            let h = Math.floor(diff/3600000);
            let m = Math.floor((diff%3600000)/60000);
            let s = Math.floor((diff%60000)/1000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        // --- PROTOCOL MGMT ---
        function renderProtocols() {
            const list = document.getElementById('protocol-list');
            list.innerHTML = OS.protocols.map(p => {
                const isDone = localStorage.getItem(`os_p_${p.id}_${new Date().toDateString()}`);
                return `
                    <div class="task-card ${isDone ? 'done' : ''}">
                        <div class="task-checkbox ${isDone ? 'checked' : ''}" onclick="toggleProtocol('${p.id}')">
                            ${isDone ? '<i class="fas fa-check" style="color:black; font-size:10px;"></i>' : ''}
                        </div>
                        <div style="margin-left:15px; flex:1;">
                            <div style="font-size:14px; font-weight:700;">${p.t}</div>
                            <div style="font-size:9px; font-weight:900; color:var(--accent); margin-top:2px;">${formatTime(p.s)} - ${formatTime(p.e)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            updateProgress();
        }

        function toggleProtocol(id) {
            const d = new Date().toDateString();
            if(localStorage.getItem(`os_p_${id}_${d}`)) {
                localStorage.removeItem(`os_p_${id}_${d}`);
            } else {
                localStorage.setItem(`os_p_${id}_${d}`, 'true');
                OS.xp += 25;
                confetti({ particleCount: 40, spread: 50, colors: ['#4285F4'] });
            }
            saveState();
            renderProtocols();
            renderXP();
        }

        function openSettings() {
            const list = document.getElementById('settings-task-list');
            list.innerHTML = OS.protocols.map(p => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:rgba(255,255,255,0.02); margin-bottom:10px; border-radius:18px; border:1px solid #222;">
                    <div>
                        <div style="font-size:14px; font-weight:700;">${p.t}</div>
                        <div style="font-size:10px; color:#555;">${formatTime(p.s)} - ${formatTime(p.e)}</div>
                    </div>
                    <i class="fas fa-trash-alt" style="color:#EA4335; padding:10px;" onclick="deleteTask('${p.id}')"></i>
                </div>
            `).join('');
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function addNewTask() {
            const name = document.getElementById('new-task-name').value;
            const start = parseInt(document.getElementById('new-task-start').value);
            const end = parseInt(document.getElementById('new-task-end').value);

            if(name && !isNaN(start)) {
                OS.protocols.push({ id: 'p' + Date.now(), t: name, s: start, e: end || 2359 });
                OS.protocols.sort((a,b) => a.s - b.s);
                localStorage.setItem('os_protocols', JSON.stringify(OS.protocols));
                renderProtocols();
                openSettings();
                document.getElementById('new-task-name').value = '';
            }
        }

        function deleteTask(id) {
            OS.protocols = OS.protocols.filter(p => p.id !== id);
            localStorage.setItem('os_protocols', JSON.stringify(OS.protocols));
            renderProtocols();
            openSettings();
        }

        // --- BATTLEFIELD & NOTES ---
        function renderCalendar() {
            const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
            const now = new Date();
            const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            for(let i=1; i<=days; i++) {
                const date = new Date(now.getFullYear(), now.getMonth(), i).toDateString();
                const dayEl = document.createElement('div');
                dayEl.className = `day-box ${date === now.toDateString() ? 'active' : ''}`;
                if(OS.history[date] >= 85) dayEl.classList.add('win');
                if(OS.notes[date]) dayEl.classList.add('has-note');
                dayEl.innerText = i;
                dayEl.onclick = () => openJournal(date);
                grid.appendChild(dayEl);
            }
        }

        function openJournal(date) {
            OS.selectedDate = date;
            document.getElementById('modal-date').innerText = date;
            document.getElementById('journal-input').value = OS.notes[date] || "";
            document.getElementById('journal-modal').style.display = 'flex';
        }

        function saveNote() {
            const val = document.getElementById('journal-input').value;
            OS.notes[OS.selectedDate] = val;
            saveState();
            renderCalendar();
            closeModal();
        }

        // --- HELPERS ---
        function formatTime(t) { return Math.floor(t/100) + ":" + (t%100).toString().padStart(2,'0'); }
        function saveState() {
            localStorage.setItem('os_xp', OS.xp);
            localStorage.setItem('os_notes', JSON.stringify(OS.notes));
            localStorage.setItem('os_history', JSON.stringify(OS.history));
        }

        function renderXP() {
            const lvl = Math.floor(OS.xp / 500) + 1;
            document.getElementById('stat-lvl').innerText = lvl;
            document.getElementById('xp-tag').innerText = `XP ${OS.xp}`;
            const ranks = ["APPRENTICE", "ELITE", "ARCHITECT", "COMMANDER", "LEGEND"];
            document.getElementById('rank-tag').innerText = ranks[Math.min(Math.floor(lvl/5), 4)];
        }

        function updateProgress() {
            const d = new Date().toDateString();
            const done = OS.protocols.filter(p => localStorage.getItem(`os_p_${p.id}_${d}`)).length;
            const pct = Math.round((done / OS.protocols.length) * 100) || 0;
            OS.history[d] = pct;
            saveState();

            let streak = 0, check = new Date();
            if(pct < 100) check.setDate(check.getDate() - 1);
            while(OS.history[check.toDateString()] >= 100) { streak++; check.setDate(check.getDate() - 1); }
            document.getElementById('stat-streak').innerText = streak;
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            el.classList.add('active');
            if(tab === 'battle') renderCalendar();
        }

        function closeModal() { 
            document.getElementById('journal-modal').style.display = 'none'; 
            document.getElementById('settings-modal').style.display = 'none'; 
        }

        function checkDailyReset() {
            const last = localStorage.getItem('os_last_run');
            const today = new Date().toDateString();
            if(last !== today) {
                localStorage.setItem('os_last_run', today);
                location.reload();
            }
        }
    </script>
</body>
</html>
